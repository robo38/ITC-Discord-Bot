<%- include('layout') %>

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="navbar-brand">
        <div class="navbar-logo">ITC</div>
        <span>Bot Dashboard</span>
    </a>
    <button class="hamburger" id="hamburgerBtn" aria-label="Menu">
        <span></span><span></span><span></span>
    </button>
    <div class="navbar-right navbar-links" id="navLinks">
        <span class="badge badge-<%= user.role %>"><%= user.role.toUpperCase() %></span>
        <div style="display:flex; align-items:center; gap:8px;">
            <img src="<%= user.avatarUrl %>" alt="" style="width:28px; height:28px; border-radius:50%;" />
            <span style="color: var(--text-secondary); font-size: 0.85rem;" class="hide-mobile"><%= user.globalName || user.username %></span>
        </div>
        <a href="/logout" class="btn btn-outline btn-sm">Logout</a>
    </div>
</nav>

<div class="container" style="max-width:1400px;">
    <div class="page-header">
        <h1 class="page-title"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-4px;margin-right:6px;"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>Web Console</h1>
        <div style="display:flex; gap:8px; align-items:center;">
            <a href="/" class="btn btn-outline btn-sm">← Back</a>
        </div>
    </div>

    <!-- Filter bar -->
    <div class="card" style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; padding:12px 16px;">
        <span style="color:var(--text-secondary); font-size:0.85rem; font-weight:600;">Filter:</span>
        <button class="log-filter-btn active" data-level="all">All</button>
        <button class="log-filter-btn" data-level="error" style="--filter-color: var(--danger);">Error</button>
        <button class="log-filter-btn" data-level="success" style="--filter-color: var(--success);">Success</button>
        <button class="log-filter-btn" data-level="database" style="--filter-color: var(--accent);">Database</button>
        <button class="log-filter-btn" data-level="debug" style="--filter-color: var(--text-secondary);">Debug</button>
        <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
            <label class="toggle-wrapper" style="gap:8px;">
                <label class="toggle" style="width:40px; height:22px;">
                    <input type="checkbox" id="autoRefresh" checked />
                    <span class="toggle-slider" style="border-radius:22px;"></span>
                </label>
                <span style="color:var(--text-secondary); font-size:0.82rem;">Auto-refresh</span>
            </label>
            <button class="btn btn-outline btn-sm" id="clearBtn">Clear</button>
        </div>
    </div>

    <!-- Log container -->
    <div class="card" style="padding:0; overflow:hidden;">
        <div id="logContainer" style="
            max-height: calc(100vh - 340px);
            overflow-y: auto;
            font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
            font-size: 0.82rem;
            line-height: 1.6;
        ">
            <div id="logEmpty" style="text-align:center; padding:40px; color:var(--text-secondary);">
                Waiting for logs...
            </div>
        </div>
    </div>

    <!-- CLI Terminal -->
    <div class="card cli-terminal" style="margin-top:12px; padding:0; overflow:hidden;">
        <div class="cli-header">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.7;"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            <span>CLI Terminal</span>
            <span class="cli-hint">Type a command and press Enter — type <strong>help</strong> for commands</span>
        </div>
        <div id="cliOutput" class="cli-output"></div>
        <div class="cli-input-row">
            <span class="cli-prompt">ITC &gt;</span>
            <input type="text" id="cliInput" class="cli-input" placeholder="Enter command..." autocomplete="off" spellcheck="false" />
        </div>
    </div>
</div>

<style>
    .log-filter-btn {
        padding: 4px 14px;
        border: 1px solid var(--border);
        border-radius: 20px;
        background: transparent;
        color: var(--text-secondary);
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }
    .log-filter-btn:hover { border-color: var(--accent); color: var(--accent); }
    .log-filter-btn.active {
        background: var(--filter-color, var(--accent));
        color: #fff;
        border-color: var(--filter-color, var(--accent));
    }

    .log-entry {
        display: grid;
        grid-template-columns: 80px 70px 1fr;
        gap: 12px;
        padding: 6px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.03);
        align-items: start;
    }
    .log-entry:hover { background: rgba(255,255,255,0.02); }

    .log-time { color: var(--text-secondary); font-size: 0.78rem; white-space: nowrap; }
    .log-level {
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        padding: 2px 8px;
        border-radius: 4px;
        text-align: center;
        white-space: nowrap;
    }
    .log-level-error { background: #f8717130; color: var(--danger); }
    .log-level-success { background: #4ade8025; color: var(--success); }
    .log-level-database { background: rgba(230,57,70,0.12); color: var(--accent); }
    .log-level-debug { background: rgba(255,255,255,0.05); color: var(--text-secondary); }

    .log-body { color: var(--text-primary); word-break: break-word; }
    .log-body .log-title { font-weight: 600; }
    .log-body .log-detail { color: var(--text-secondary); margin-left: 8px; }

    /* ─── CLI Terminal ─────────────────────────────────── */
    .cli-terminal {
        border: 1px solid var(--border);
        border-top: 2px solid var(--accent);
    }
    .cli-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255,255,255,0.02);
        border-bottom: 1px solid var(--border);
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .cli-hint {
        margin-left: auto;
        font-size: 0.72rem;
        font-weight: 400;
        opacity: 0.5;
    }
    .cli-output {
        max-height: 200px;
        overflow-y: auto;
        padding: 0;
        font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
        font-size: 0.8rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        color: var(--text-primary);
    }
    .cli-output:empty { display: none; }
    .cli-output .cli-entry {
        padding: 4px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.025);
    }
    .cli-output .cli-cmd {
        color: var(--accent);
        font-weight: 600;
    }
    .cli-output .cli-cmd::before {
        content: 'ITC > ';
        color: var(--text-secondary);
        font-weight: 400;
    }
    .cli-output .cli-res {
        color: var(--text-secondary);
        padding-left: 0;
    }
    .cli-input-row {
        display: flex;
        align-items: center;
        padding: 0 16px;
        border-top: 1px solid var(--border);
        background: rgba(0,0,0,0.15);
    }
    .cli-prompt {
        color: var(--accent);
        font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
        font-size: 0.85rem;
        font-weight: 700;
        margin-right: 10px;
        white-space: nowrap;
        user-select: none;
    }
    .cli-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: var(--text-primary);
        font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
        font-size: 0.84rem;
        padding: 12px 0;
        caret-color: var(--accent);
    }
    .cli-input::placeholder { color: var(--text-secondary); opacity: 0.35; }
    .cli-input:disabled { opacity: 0.4; }
</style>

<script src="/socket.io/socket.io.js"></script>
<script>
    const container = document.getElementById('logContainer');
    const emptyEl = document.getElementById('logEmpty');
    const filterBtns = document.querySelectorAll('.log-filter-btn');
    const autoRefreshCb = document.getElementById('autoRefresh');
    const clearBtn = document.getElementById('clearBtn');

    let currentLevel = 'all';
    let lastTimestamp = 0;
    let socket = null;

    // ─── Socket.IO for live logs ─────────────────────────────────
    function initSocket() {
        socket = io();
        socket.on('connect', function() {
            socket.emit('join:console');
        });
        socket.on('log:new', function(log) {
            if (currentLevel !== 'all' && log.level !== currentLevel) return;
            if (log.timestamp <= lastTimestamp) return;

            // Remove empty state
            if (emptyEl && emptyEl.parentNode === container) {
                container.removeChild(emptyEl);
            }

            var wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 20;
            container.appendChild(createLogEntry(log));
            lastTimestamp = log.timestamp;

            if (wasAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        });
    }

    // Filter buttons
    filterBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            filterBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            currentLevel = btn.dataset.level;
            lastTimestamp = 0;
            container.innerHTML = '';
            fetchLogs(); // Initial load when switching filter
        });
    });

    clearBtn.addEventListener('click', () => {
        container.innerHTML = '';
        emptyEl && container.appendChild(emptyEl);
    });

    function formatTime(ts) {
        const d = new Date(ts);
        return d.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function createLogEntry(log) {
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `
            <span class="log-time">${formatTime(log.timestamp)}</span>
            <span class="log-level log-level-${log.level}">${log.level}</span>
            <span class="log-body">
                <span class="log-title">${escapeHtml(log.title)}</span>
                ${log.body ? '<span class="log-detail">' + escapeHtml(log.body) + '</span>' : ''}
            </span>
        `;
        return div;
    }

    function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    async function fetchLogs() {
        try {
            const url = `/api/logs?limit=200&level=${currentLevel}`;
            const res = await fetch(url);
            if (!res.ok) return;
            const logs = await res.json();
            if (!logs.length) return;

            // Remove empty state
            if (emptyEl && emptyEl.parentNode === container) {
                container.removeChild(emptyEl);
            }

            // Render all fetched logs
            logs.forEach(log => container.appendChild(createLogEntry(log)));
            lastTimestamp = Math.max(...logs.map(l => l.timestamp));

            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        } catch (e) { /* silent */ }
    }

    // Auto-refresh toggle controls socket connection
    autoRefreshCb.addEventListener('change', () => {
        if (autoRefreshCb.checked) {
            if (!socket || !socket.connected) initSocket();
        } else {
            if (socket) { socket.disconnect(); socket = null; }
        }
    });

    // Initial load: fetch existing logs + connect socket
    fetchLogs();
    initSocket();

    // ─── CLI Terminal ────────────────────────────────────────────
    (function() {
        const cliInput = document.getElementById('cliInput');
        const cliOutput = document.getElementById('cliOutput');
        const history = [];
        let historyIdx = -1;

        cliInput.addEventListener('keydown', function(e) {
            // Arrow up/down for command history
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                if (historyIdx < history.length - 1) {
                    historyIdx++;
                    cliInput.value = history[history.length - 1 - historyIdx];
                }
                return;
            }
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                if (historyIdx > 0) {
                    historyIdx--;
                    cliInput.value = history[history.length - 1 - historyIdx];
                } else {
                    historyIdx = -1;
                    cliInput.value = '';
                }
                return;
            }
            if (e.key !== 'Enter') return;
            e.preventDefault();

            const cmd = cliInput.value.trim();
            if (!cmd) return;

            history.push(cmd);
            historyIdx = -1;
            cliInput.value = '';
            cliInput.disabled = true;

            // Show command in output
            const entry = document.createElement('div');
            entry.className = 'cli-entry';
            entry.innerHTML = '<div class="cli-cmd">' + escapeHtml(cmd) + '</div>';
            cliOutput.appendChild(entry);
            cliOutput.scrollTop = cliOutput.scrollHeight;

            // Send via socket
            if (!socket || !socket.connected) {
                appendResult(entry, 'Not connected to server.');
                cliInput.disabled = false;
                cliInput.focus();
                return;
            }

            socket.emit('cli:exec', cmd);

            // Listen for result (one-time)
            socket.once('cli:result', function(data) {
                if (data.clear) {
                    cliOutput.innerHTML = '';
                } else if (data.output) {
                    appendResult(entry, data.output);
                }
                cliInput.disabled = false;
                cliInput.focus();
                cliOutput.scrollTop = cliOutput.scrollHeight;
            });

            // Timeout fallback
            setTimeout(function() {
                if (cliInput.disabled) {
                    cliInput.disabled = false;
                    cliInput.focus();
                }
            }, 10000);
        });

        function appendResult(entry, text) {
            const res = document.createElement('div');
            res.className = 'cli-res';
            res.textContent = text;
            entry.appendChild(res);
        }

        // Focus input on terminal click
        document.querySelector('.cli-terminal').addEventListener('click', function() {
            cliInput.focus();
        });
    })();
</script>

<%- include('footer') %>
