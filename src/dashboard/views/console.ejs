<%- include('layout') %>

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="navbar-brand">
        <div class="navbar-logo">ITC</div>
        <span>Bot Dashboard</span>
    </a>
    <button class="hamburger" id="hamburgerBtn" aria-label="Menu">
        <span></span><span></span><span></span>
    </button>
    <div class="navbar-right navbar-links" id="navLinks">
        <span class="badge badge-<%= user.role %>"><%= user.role.toUpperCase() %></span>
        <div style="display:flex; align-items:center; gap:8px;">
            <img src="<%= user.avatarUrl %>" alt="" style="width:28px; height:28px; border-radius:50%;" />
            <span style="color: var(--text-secondary); font-size: 0.85rem;" class="hide-mobile"><%= user.globalName || user.username %></span>
        </div>
        <a href="/logout" class="btn btn-outline btn-sm">Logout</a>
    </div>
</nav>

<div class="container" style="max-width:1000px;">
    <div class="page-header">
        <h1 class="page-title"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-4px;margin-right:6px;"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>Terminal</h1>
        <a href="/dev" class="btn btn-outline btn-sm">← Dev Panel</a>
    </div>

    <!-- CLI Terminal -->
    <div class="card cli-terminal" style="padding:0; overflow:hidden;">
        <div class="cli-header">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="opacity:0.7;"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></svg>
            <span>CLI Terminal</span>
            <span class="cli-hint">Type a command and press Enter — type <strong>help</strong> for commands</span>
        </div>
        <div id="cliOutput" class="cli-output"></div>
        <div class="cli-input-row">
            <span class="cli-prompt">ITC &gt;</span>
            <input type="text" id="cliInput" class="cli-input" placeholder="Enter command..." autocomplete="off" spellcheck="false" />
        </div>
    </div>
</div>

<style>
    /* ─── CLI Terminal ─────────────────────────────────── */
    .cli-terminal {
        border: 1px solid var(--border);
        border-top: 2px solid var(--accent);
    }
    .cli-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 16px;
        background: rgba(255,255,255,0.02);
        border-bottom: 1px solid var(--border);
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .cli-hint {
        margin-left: auto;
        font-size: 0.72rem;
        font-weight: 400;
        opacity: 0.5;
    }
    .cli-output {
        min-height: 120px;
        max-height: calc(100vh - 280px);
        overflow-y: auto;
        padding: 0;
        font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
        font-size: 0.8rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        color: var(--text-primary);
    }
    .cli-output:empty {
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-secondary);
        opacity: 0.3;
        font-size: 0.85rem;
    }
    .cli-output:empty::after {
        content: 'Ready — type help to get started';
    }
    .cli-output .cli-entry {
        padding: 4px 16px;
        border-bottom: 1px solid rgba(255,255,255,0.025);
    }
    .cli-output .cli-cmd {
        color: var(--accent);
        font-weight: 600;
    }
    .cli-output .cli-cmd::before {
        content: 'ITC > ';
        color: var(--text-secondary);
        font-weight: 400;
    }
    .cli-output .cli-res {
        color: var(--text-secondary);
        padding-left: 0;
    }
    .cli-input-row {
        display: flex;
        align-items: center;
        padding: 0 16px;
        border-top: 1px solid var(--border);
        background: rgba(0,0,0,0.15);
    }
    .cli-prompt {
        color: var(--accent);
        font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
        font-size: 0.85rem;
        font-weight: 700;
        margin-right: 10px;
        white-space: nowrap;
        user-select: none;
    }
    .cli-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: var(--text-primary);
        font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
        font-size: 0.84rem;
        padding: 12px 0;
        caret-color: var(--accent);
    }
    .cli-input::placeholder { color: var(--text-secondary); opacity: 0.35; }
    .cli-input:disabled { opacity: 0.4; }
</style>

<script src="/socket.io/socket.io.js"></script>
<script>
(function() {
    var socket = io();
    var cliInput = document.getElementById('cliInput');
    var cliOutput = document.getElementById('cliOutput');
    var history = [];
    var historyIdx = -1;

    socket.on('connect', function() {
        socket.emit('join:console');
    });

    function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    cliInput.addEventListener('keydown', function(e) {
        // Arrow up/down for command history
        if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (history.length && historyIdx < history.length - 1) {
                historyIdx++;
                cliInput.value = history[history.length - 1 - historyIdx];
            }
            return;
        }
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (historyIdx > 0) {
                historyIdx--;
                cliInput.value = history[history.length - 1 - historyIdx];
            } else {
                historyIdx = -1;
                cliInput.value = '';
            }
            return;
        }
        if (e.key !== 'Enter') return;
        e.preventDefault();

        var cmd = cliInput.value.trim();
        if (!cmd) return;

        history.push(cmd);
        historyIdx = -1;
        cliInput.value = '';
        cliInput.disabled = true;

        // Show command in output
        var entry = document.createElement('div');
        entry.className = 'cli-entry';
        entry.innerHTML = '<div class="cli-cmd">' + escapeHtml(cmd) + '</div>';
        cliOutput.appendChild(entry);
        cliOutput.scrollTop = cliOutput.scrollHeight;

        // Send via socket
        if (!socket || !socket.connected) {
            appendResult(entry, 'Not connected to server.');
            cliInput.disabled = false;
            cliInput.focus();
            return;
        }

        socket.emit('cli:exec', cmd);

        // Listen for result (one-time)
        socket.once('cli:result', function(data) {
            if (data.clear) {
                cliOutput.innerHTML = '';
            } else if (data.output) {
                appendResult(entry, data.output);
            }
            cliInput.disabled = false;
            cliInput.focus();
            cliOutput.scrollTop = cliOutput.scrollHeight;
        });

        // Timeout fallback
        setTimeout(function() {
            if (cliInput.disabled) {
                cliInput.disabled = false;
                cliInput.focus();
            }
        }, 10000);
    });

    function appendResult(entry, text) {
        var res = document.createElement('div');
        res.className = 'cli-res';
        res.textContent = text;
        entry.appendChild(res);
    }

    // Focus input on terminal click
    document.querySelector('.cli-terminal').addEventListener('click', function() {
        cliInput.focus();
    });

    // Auto-focus on load
    cliInput.focus();
})();
</script>

<%- include('footer') %>
