<!-- ─── Global Context Menu ────────────────────────────────────────── -->
<div class="ctx-menu" id="globalCtxMenu"></div>

<!-- ─── Global Snackbar (for split bot selection etc.) ────────────── -->
<div class="snackbar" id="globalSnackbar">
    <button class="snackbar-close" onclick="window._snackbar.hide()">&times;</button>
    <div class="snackbar-title" id="snackbarTitle"></div>
    <div class="snackbar-options" id="snackbarOptions"></div>
</div>

<!-- ─── Copy Toast ───────────────────────────────────────────────── -->
<div class="copy-toast" id="globalCopyToast">Copied!</div>

<script>
    // ─── Dropdown toggle ──────────────────────────────────────────
    document.addEventListener('click', function(e) {
        document.querySelectorAll('.dropdown-wrapper.open').forEach(function(el) {
            if (!el.contains(e.target)) el.classList.remove('open');
        });
        var trigger = e.target.closest('.dropdown-trigger');
        if (trigger) {
            e.stopPropagation();
            var wrapper = trigger.closest('.dropdown-wrapper');
            var wasOpen = wrapper.classList.contains('open');
            document.querySelectorAll('.dropdown-wrapper.open').forEach(function(el) { el.classList.remove('open'); });
            if (!wasOpen) wrapper.classList.add('open');
        }
    });

    // ─── Custom select styling ────────────────────────────────────
    document.querySelectorAll('select').forEach(function(sel) {
        sel.style.appearance = 'none';
        sel.style.backgroundImage = "url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23a08a8e' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E\")";
        sel.style.backgroundRepeat = 'no-repeat';
        sel.style.backgroundPosition = 'right 12px center';
        sel.style.paddingRight = '36px';
    });

    // ─── Global Toast Utility ─────────────────────────────────────
    window._toast = function(msg) {
        var t = document.getElementById('globalCopyToast') || document.getElementById('copyToast');
        if (!t) return;
        t.textContent = msg || 'Done';
        t.classList.add('show');
        setTimeout(function() { t.classList.remove('show'); }, 2200);
    };

    // ─── Global Copy-to-clipboard ─────────────────────────────────
    document.addEventListener('click', function(e) {
        var el = e.target.closest('.copy-text');
        if (el) {
            var val = el.dataset.copy || el.textContent.trim();
            navigator.clipboard.writeText(val).then(function() { window._toast('Copied: ' + val); });
        }
    });

    // ─── Global Snackbar System ───────────────────────────────────
    window._snackbar = {
        _el: null,
        _titleEl: null,
        _optsEl: null,
        _callback: null,
        init: function() {
            this._el = document.getElementById('globalSnackbar');
            this._titleEl = document.getElementById('snackbarTitle');
            this._optsEl = document.getElementById('snackbarOptions');
        },
        show: function(title, options, callback) {
            if (!this._el) this.init();
            this._titleEl.textContent = title;
            this._optsEl.innerHTML = '';
            this._callback = callback;
            var self = this;
            options.forEach(function(opt) {
                var btn = document.createElement('button');
                btn.className = 'snackbar-option';
                btn.textContent = opt.label;
                btn.addEventListener('click', function() {
                    self._optsEl.querySelectorAll('.snackbar-option').forEach(function(b) { b.classList.remove('selected'); });
                    btn.classList.add('selected');
                    if (self._callback) self._callback(opt.value);
                    setTimeout(function() { self.hide(); }, 400);
                });
                self._optsEl.appendChild(btn);
            });
            this._el.classList.add('show');
        },
        hide: function() {
            if (this._el) this._el.classList.remove('show');
        }
    };

    // ─── Global Context Menu Engine ───────────────────────────────
    window._ctxMenu = {
        _el: null,
        _handlers: {},
        init: function() {
            this._el = document.getElementById('globalCtxMenu');
            var self = this;
            // Close on click/scroll/escape
            document.addEventListener('click', function() { self.close(); });
            document.addEventListener('scroll', function() { self.close(); }, true);
            document.addEventListener('keydown', function(e) { if (e.key === 'Escape') self.close(); });
        },
        close: function() {
            if (this._el) this._el.classList.remove('open');
        },
        /**
         * Open context menu at (x, y) with items array:
         * [{ icon, label, action, danger, divider }]
         */
        open: function(e, items, context) {
            e.preventDefault();
            e.stopPropagation();
            if (!this._el) this.init();

            this._el.innerHTML = '';
            var self = this;

            items.forEach(function(item) {
                if (item.divider) {
                    var d = document.createElement('div');
                    d.className = 'ctx-menu-divider';
                    self._el.appendChild(d);
                    return;
                }
                var div = document.createElement('div');
                div.className = 'ctx-menu-item' + (item.danger ? ' danger' : '');
                div.innerHTML = (item.icon || '') + ' ' + item.label;
                div.addEventListener('click', function(ev) {
                    ev.stopPropagation();
                    self.close();
                    if (item.action) item.action(context);
                });
                self._el.appendChild(div);
            });

            this._el.style.left = e.clientX + 'px';
            this._el.style.top = e.clientY + 'px';
            this._el.classList.add('open');

            // Reposition if off-screen
            var self2 = this;
            setTimeout(function() {
                var rect = self2._el.getBoundingClientRect();
                if (rect.right > window.innerWidth) self2._el.style.left = (e.clientX - rect.width) + 'px';
                if (rect.bottom > window.innerHeight) self2._el.style.top = (e.clientY - rect.height) + 'px';
            }, 0);
        }
    };
    window._ctxMenu.init();

    // ─── SVG icon helpers for context menu ────────────────────────
    window._ctxIcons = {
        view: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>',
        members: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>',
        toggle: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
        reconnect: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>',
        disconnect: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16.5 12a4.5 4.5 0 0 0-9 0"/><line x1="1" y1="1" x2="23" y2="23"/></svg>',
        trash: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>',
        copy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>',
        stop: '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>',
        download: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>',
        info: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>',
        user: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>',
        trophy: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 22V8h4v14"/><path d="M6 2h12v7a6 6 0 0 1-12 0V2z"/></svg>'
    };
</script>
</body>
</html>
