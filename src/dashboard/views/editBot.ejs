<%- include('layout') %>

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="navbar-brand">
        <div class="navbar-logo">ITC</div>
        <span>Bot Dashboard</span>
    </a>
    <div class="navbar-right">
        <span class="badge badge-<%= user.role %>"><%= user.role.toUpperCase() %></span>
        <div style="display:flex; align-items:center; gap:8px;">
            <img src="<%= user.avatarUrl %>" alt="" style="width:28px; height:28px; border-radius:50%;" />
            <span style="color: var(--text-secondary); font-size: 0.85rem;"><%= user.globalName || user.username %></span>
        </div>
        <a href="/logout" class="btn btn-outline btn-sm">Logout</a>
    </div>
</nav>

<div class="container">
    <div class="page-header">
        <h1 class="page-title">Edit: <%= bot.teamName %></h1>
        <a href="/bots/<%= bot._id %>" class="btn btn-outline">‚Üê Back</a>
    </div>

    <% if (error) { %>
        <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <form method="POST" action="/bots/<%= bot._id %>/edit">
        <div class="card" style="max-width: 800px;">
            <h3 style="margin-bottom: 20px; color: var(--accent);">Team Information</h3>

            <div class="form-row">
                <div class="form-group">
                    <label>Team Name *</label>
                    <input type="text" name="teamName" value="<%= bot.teamName %>" required />
                </div>
                <div class="form-group">
                    <label>Leader Role ID *</label>
                    <input type="text" name="leaderRoleId" value="<%= bot.leaderRoleId || '' %>" required />
                    <div class="form-hint">Anyone with this role will be considered a leader for this team</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Members Role ID *</label>
                    <input type="text" name="membersRoleId" value="<%= bot.membersRoleId %>" required />
                </div>
                <div class="form-group">
                    <label>Additional Members Role ID</label>
                    <input type="text" name="additionalMembersRoleId" value="<%= bot.additionalMembersRoleId || '' %>" />
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Leader Chat Channel ID *</label>
                    <input type="text" name="leaderChatChannelId" value="<%= bot.leaderChatChannelId %>" required />
                </div>
                <div class="form-group">
                    <label>General Announcement Channel ID *</label>
                    <input type="text" name="generalAnnChannelId" value="<%= bot.generalAnnChannelId %>" required />
                </div>
            </div>

            <div class="form-group">
                <label>Active</label>
                <div class="toggle-wrapper">
                    <label class="toggle">
                        <input type="checkbox" name="isActive" value="true" <%= bot.isActive ? 'checked' : '' %> />
                        <span class="toggle-slider"></span>
                    </label>
                    <span style="color: var(--text-secondary);">Bot is <%= bot.isActive ? 'active' : 'inactive' %></span>
                </div>
            </div>
        </div>

        <div class="card" style="max-width: 800px;">
            <h3 style="margin-bottom: 20px; color: var(--accent);">Bot Configuration</h3>

            <div class="form-group">
                <label>Split Mode</label>
                <div class="toggle-wrapper">
                    <label class="toggle">
                        <input type="checkbox" name="isSplit" value="true" id="splitToggle" <%= bot.isSplit ? 'checked' : '' %> onchange="toggleSplit()" />
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="splitLabel" style="color: var(--text-secondary);">
                        <%= bot.isSplit ? 'Yes ‚Äî Two bots (Beginner + Advanced)' : 'No ‚Äî Single bot' %>
                    </span>
                </div>
            </div>

            <!-- Single bot fields -->
            <div id="singleBotSection" style="display: <%= bot.isSplit ? 'none' : 'block' %>;">
                <% if (user.role === 'dev') { %>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bot Token</label>
                        <input type="text" name="botToken" value="<%= bot.botToken || '' %>" />
                    </div>
                    <div class="form-group">
                        <label>Bot ID</label>
                        <input type="text" name="botId" value="<%= bot.botId || '' %>" />
                    </div>
                </div>
                <% } else if (user.role === 'be') { %>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bot Token</label>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <input type="text" value="**********" disabled style="flex:1; opacity:0.5;" />
                            <button type="button" class="btn btn-outline btn-sm token-request-btn" data-bot="<%= bot._id %>" data-label="Bot Token" style="white-space:nowrap;">üîë Request</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Bot ID</label>
                        <input type="text" value="**********" disabled style="opacity:0.5;" />
                    </div>
                </div>
                <% } else { %>
                <div class="form-row">
                    <div class="form-group">
                        <label>Bot Token</label>
                        <input type="text" value="**********" disabled style="opacity:0.5;" />
                    </div>
                    <div class="form-group">
                        <label>Bot ID</label>
                        <input type="text" value="**********" disabled style="opacity:0.5;" />
                    </div>
                </div>
                <% } %>
                <div class="form-group">
                    <label>Voice Channel ID</label>
                    <input type="text" name="voiceChannelId" value="<%= bot.voiceChannelId || '' %>" />
                </div>
            </div>

            <!-- Split bot fields -->
            <div id="splitBotSection" style="display: <%= bot.isSplit ? 'block' : 'none' %>;">
                <div class="split-section">
                    <h3>üü¢ Bot 1 (Beginner)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bot Token 1</label>
                            <% if (user.role === 'dev') { %>
                                <input type="text" name="botToken1" value="<%= bot.splitConfig ? bot.splitConfig.botToken1 : '' %>" />
                            <% } else if (user.role === 'be') { %>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <input type="text" value="**********" disabled style="flex:1; opacity:0.5;" />
                                    <button type="button" class="btn btn-outline btn-sm token-request-btn" data-bot="<%= bot._id %>" data-label="Bot 1 Token" style="white-space:nowrap;">üîë Request</button>
                                </div>
                            <% } else { %>
                                <input type="text" value="**********" disabled style="opacity:0.5;" />
                            <% } %>
                        </div>
                        <div class="form-group">
                            <label>Voice Channel 1</label>
                            <input type="text" name="voiceChannelId1" value="<%= bot.splitConfig ? bot.splitConfig.voiceChannelId1 : '' %>" />
                        </div>
                    </div>
                </div>

                <div class="split-section" style="margin-top: 12px;">
                    <h3>üîµ Bot 2 (Advanced)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Bot Token 2</label>
                            <% if (user.role === 'dev') { %>
                                <input type="text" name="botToken2" value="<%= bot.splitConfig ? bot.splitConfig.botToken2 : '' %>" />
                            <% } else if (user.role === 'be') { %>
                                <div style="display:flex; align-items:center; gap:8px;">
                                    <input type="text" value="**********" disabled style="flex:1; opacity:0.5;" />
                                    <button type="button" class="btn btn-outline btn-sm token-request-btn" data-bot="<%= bot._id %>" data-label="Bot 2 Token" style="white-space:nowrap;">üîë Request</button>
                                </div>
                            <% } else { %>
                                <input type="text" value="**********" disabled style="opacity:0.5;" />
                            <% } %>
                        </div>
                        <div class="form-group">
                            <label>Voice Channel 2</label>
                            <input type="text" name="voiceChannelId2" value="<%= bot.splitConfig ? bot.splitConfig.voiceChannelId2 : '' %>" />
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 16px;">
                    <label>Special Role for Split (Optional)</label>
                    <input type="text" name="specialRoleId" value="<%= bot.splitConfig ? bot.splitConfig.specialRoleId || '' : '' %>" />
                </div>
            </div>
        </div>

        <div style="max-width: 800px; display:flex; gap:12px; justify-content:flex-end;">
            <a href="/bots/<%= bot._id %>" class="btn btn-outline">Cancel</a>
            <button type="submit" class="btn btn-primary btn-lg">Save Changes</button>
        </div>
    </form>
</div>

<script>
    function toggleSplit() {
        const checked = document.getElementById('splitToggle').checked;
        document.getElementById('singleBotSection').style.display = checked ? 'none' : 'block';
        document.getElementById('splitBotSection').style.display = checked ? 'block' : 'none';
        document.getElementById('splitLabel').textContent = checked
            ? 'Yes ‚Äî Two bots (Beginner + Advanced)'
            : 'No ‚Äî Single bot';
    }

    // Token access request buttons (BE role)
    document.querySelectorAll('.token-request-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
            btn.disabled = true;
            btn.textContent = 'Sending...';
            try {
                var res = await fetch('/api/token-request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ botId: btn.dataset.bot, label: btn.dataset.label })
                });
                if (res.ok) {
                    btn.textContent = '‚úì Sent';
                    btn.style.color = 'var(--success)';
                    btn.style.borderColor = 'var(--success)';
                } else {
                    btn.textContent = '‚úó Failed';
                    btn.style.color = 'var(--danger)';
                    setTimeout(function() { btn.textContent = 'üîë Request'; btn.disabled = false; btn.style.color = ''; btn.style.borderColor = ''; }, 3000);
                }
            } catch (e) {
                btn.textContent = '‚úó Error';
                setTimeout(function() { btn.textContent = 'üîë Request'; btn.disabled = false; }, 3000);
            }
        });
    });
</script>

<%- include('footer') %>
