<%- include('layout') %>

<!-- Navbar -->
<nav class="navbar">
    <a href="/" class="navbar-brand">
        <div class="navbar-logo">ITC</div>
        <span>Bot Dashboard</span>
    </a>
    <button class="hamburger" id="hamburgerBtn" aria-label="Menu">
        <span></span><span></span><span></span>
    </button>
    <div class="navbar-right navbar-links" id="navLinks">
        <span class="badge badge-<%= user.role %>"><%= user.role.toUpperCase() %></span>
        <div style="display:flex; align-items:center; gap:8px;">
            <img src="<%= user.avatarUrl %>" alt="" style="width:28px; height:28px; border-radius:50%;" />
            <span style="color: var(--text-secondary); font-size: 0.85rem;" class="hide-mobile"><%= user.globalName || user.username %></span>
        </div>
        <a href="/logout" class="btn btn-outline btn-sm">Logout</a>
    </div>
</nav>

<!-- Copy toast -->
<div class="copy-toast" id="copyToast">Copied!</div>

<div class="container">
    <div class="page-header">
        <h1 class="page-title"><%= bot.teamName %></h1>
        <div style="display:flex; gap:8px;">
            <% if (user.role !== 'leader') { %>
                <a href="/bots/<%= bot._id %>/edit" class="btn btn-primary btn-sm">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Edit
                </a>
            <% } %>
            <% if (user.role !== 'leader') { %>
                <a href="/" class="btn btn-outline btn-sm">← Back</a>
            <% } %>
        </div>
    </div>

    <!-- Status bar + controls -->
    <div class="card" style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px;">
        <div style="display:flex; align-items:center; gap:16px;">
            <% var hasActiveWs = workshops.some(function(w) { return w.status === 'active'; }); %>
            <span class="status-dot <%= bot.isActive ? (hasActiveWs ? 'status-active status-glow' : 'status-active') : 'status-inactive' %>" style="width:14px;height:14px;"></span>
            <div>
                <strong style="font-size:1.1rem;"><%= bot.teamName %></strong>
                <span style="color:var(--text-secondary); margin-left:12px;">
                    <%= bot.isActive ? 'Active' : 'Inactive' %> · <%= bot.isSplit ? 'Split Mode' : 'Single Bot' %>
                </span>
            </div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
            <% if (user.role !== 'leader') { %>
                <button class="btn-icon" id="disconnectBtn" title="Disconnect from voice">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16.5 12a4.5 4.5 0 0 0-9 0"/><line x1="1" y1="1" x2="23" y2="23"/><path d="M20.84 4.61a14 14 0 0 1 0 14.78"/><path d="M3.16 4.61a14 14 0 0 0 0 14.78"/></svg>
                </button>
                <button class="btn-icon" id="reconnectBtn" title="Reconnect to voice">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/></svg>
                </button>
            <% } %>
            <button class="btn-icon" id="teamMembersBtn" title="Team Members" style="border-color: var(--accent); color: var(--accent);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </button>
            <button class="btn-icon" id="leaderboardBtn" title="Team Leaderboard" style="border-color: var(--warning); color: var(--warning);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 21h8"/><path d="M12 17V3"/><path d="M17 7l-5-4-5 4"/><path d="M6 21V11"/><path d="M18 21V11"/></svg>
            </button>
        </div>
    </div>

    <!-- Leaders section (overlapping avatars) -->
    <div class="card">
        <h3 style="margin-bottom:14px; color:var(--accent); font-size:1rem;">Team Leaders</h3>
        <% if (bot.leaders && bot.leaders.length > 0) { %>
            <div class="avatar-stack" style="gap: 0;">
                <% bot.leaders.forEach(function(leader) { %>
                    <% var isOnline = (typeof onlineUserIds !== 'undefined' && onlineUserIds) ? onlineUserIds.indexOf(leader.id) !== -1 : false; %>
                    <div class="avatar-item leader-avatar"
                         data-leader-id="<%= leader.id %>"
                         data-leader-name="<%= (leader.globalName || leader.username).replace(/"/g, '&quot;') %>"
                         data-leader-username="<%= leader.username %>"
                         data-leader-avatar="<%= leader.avatarUrl %>"
                         data-leader-sessions="<%= leader.sessionCount || 0 %>"
                         data-leader-team="<%= bot.teamName %>"
                         data-leader-roles="<%= (leader.roles || []).join('|||') %>"
                         data-leader-online="<%= isOnline %>"
                         style="width:44px;height:44px;border:2px solid var(--accent); position:relative; cursor:pointer;">
                        <img src="<%= leader.avatarUrl %>" alt="<%= leader.username %>" />
                        <span class="leader-online-dot" style="position:absolute;bottom:0;right:0;width:12px;height:12px;border-radius:50%;border:2px solid var(--bg-card);display:<%= isOnline ? 'block' : 'none' %>;background:var(--success);animation:pulse-glow 1.5s ease-in-out infinite;"></span>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <p style="color:var(--text-secondary);">No members with the leader role found in the server cache.</p>
        <% } %>
        <div class="info-row" style="margin-top:12px;">
            <span class="info-label">Leader Role</span>
            <span class="info-value">
                <% if (bot.leaderRoleId) { %>
                    <span class="role-tag copy-text" data-copy="<%= bot.leaderRoleId %>">
                        <%= resolvedRoles.leaderRoleName %>
                        <span class="role-id-tip"><%= bot.leaderRoleId %></span>
                    </span>
                <% } else { %>—<% } %>
            </span>
        </div>
    </div>

    <!-- Bot info -->
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
        <div class="card">
            <h3 style="margin-bottom:14px; color:var(--accent); font-size:1rem;">Team Info</h3>
            <div class="info-row">
                <span class="info-label">Team Name</span>
                <span class="info-value"><%= bot.teamName %></span>
            </div>
            <div class="info-row">
                <span class="info-label">Members Role</span>
                <span class="info-value">
                    <% if (bot.membersRoleId) { %>
                        <span class="role-tag copy-text" data-copy="<%= bot.membersRoleId %>">
                            <%= resolvedRoles.membersRoleName %>
                            <span class="role-id-tip"><%= bot.membersRoleId %></span>
                        </span>
                    <% } else { %>—<% } %>
                </span>
            </div>
            <div class="info-row">
                <span class="info-label">Additional Role</span>
                <span class="info-value">
                    <% if (bot.additionalMembersRoleId) { %>
                        <span class="role-tag copy-text" data-copy="<%= bot.additionalMembersRoleId %>">
                            <%= resolvedRoles.additionalRoleName %>
                            <span class="role-id-tip"><%= bot.additionalMembersRoleId %></span>
                        </span>
                    <% } else { %>—<% } %>
                </span>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom:14px; color:var(--accent); font-size:1rem;">Channels</h3>
            <div class="info-row">
                <span class="info-label">Leader Chat</span>
                <span class="info-value" title="<%= bot.leaderChatChannelId || '' %>"><%= resolvedChannels.leaderChatName %></span>
            </div>
            <div class="info-row">
                <span class="info-label">General Announcement</span>
                <span class="info-value" title="<%= bot.generalAnnChannelId || '' %>"><%= resolvedChannels.generalAnnName %></span>
            </div>
            <% if (!bot.isSplit) { %>
                <div class="info-row">
                    <span class="info-label">Voice Channel</span>
                    <span class="info-value" title="<%= bot.voiceChannelId || '' %>"><%= resolvedChannels.voiceChannelName %></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Bot ID</span>
                    <span class="info-value"><%= bot.botId || '—' %></span>
                </div>
            <% } %>
        </div>
    </div>

    <% if (bot.isSplit && bot.splitConfig) { %>
        <div class="card">
            <h3 style="margin-bottom:14px; color:var(--accent); font-size:1rem;">Split Configuration</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
                <div>
                    <h4 style="color:var(--success); margin-bottom:10px;"><span class="dot-icon dot-green"></span> Bot 1 (Beginner)</h4>
                    <div class="info-row">
                        <span class="info-label">Token</span>
                        <% if (user.role === 'dev') { %>
                            <span class="info-value" style="font-family:monospace; font-size:0.8rem;">
                                <%= bot.splitConfig.botToken1 ? '••••••' + bot.splitConfig.botToken1.slice(-6) : '—' %>
                            </span>
                        <% } else if (user.role === 'be') { %>
                            <span class="info-value token-masked" style="font-family:monospace; font-size:0.8rem;">
                                **********
                                <button class="btn btn-outline btn-sm token-request-btn" data-bot="<%= bot._id %>" data-label="Bot 1 Token" style="margin-left:8px; font-size:0.7rem; padding:2px 10px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:3px;"><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.78 7.78 5.5 5.5 0 0 1 7.78-7.78Zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>Request Access</button>
                            </span>
                        <% } else { %>
                            <span class="info-value" style="font-family:monospace; font-size:0.8rem;">**********</span>
                        <% } %>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Voice Channel</span>
                        <span class="info-value"><%= bot.splitConfig.voiceChannelId1 %></span>
                    </div>
                </div>
                <div>
                    <h4 style="color:var(--accent); margin-bottom:10px;"><span class="dot-icon dot-blue"></span> Bot 2 (Advanced)</h4>
                    <div class="info-row">
                        <span class="info-label">Token</span>
                        <% if (user.role === 'dev') { %>
                            <span class="info-value" style="font-family:monospace; font-size:0.8rem;">
                                <%= bot.splitConfig.botToken2 ? '••••••' + bot.splitConfig.botToken2.slice(-6) : '—' %>
                            </span>
                        <% } else if (user.role === 'be') { %>
                            <span class="info-value token-masked" style="font-family:monospace; font-size:0.8rem;">
                                **********
                                <button class="btn btn-outline btn-sm token-request-btn" data-bot="<%= bot._id %>" data-label="Bot 2 Token" style="margin-left:8px; font-size:0.7rem; padding:2px 10px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-1px;margin-right:3px;"><path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.78 7.78 5.5 5.5 0 0 1 7.78-7.78Zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>Request Access</button>
                            </span>
                        <% } else { %>
                            <span class="info-value" style="font-family:monospace; font-size:0.8rem;">**********</span>
                        <% } %>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Voice Channel</span>
                        <span class="info-value"><%= bot.splitConfig.voiceChannelId2 %></span>
                    </div>
                </div>
            </div>
            <% if (bot.splitConfig.specialRoleId) { %>
                <div class="info-row" style="margin-top:12px;">
                    <span class="info-label">Special Split Role</span>
                    <span class="info-value"><%= bot.splitConfig.specialRoleId %></span>
                </div>
            <% } %>
        </div>
    <% } %>

    <!-- Workshop Control (button → opens modal) -->
    <div class="card">
        <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:10px;">
            <h3 style="color:var(--accent); font-size:1rem; margin:0;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>Workshop Control</h3>
            <div id="wsControlStatus" style="font-size:0.88rem; color:var(--text-secondary);"></div>
            <div style="display:flex; gap:8px;">
                <button class="btn btn-success btn-sm" id="wsOpenModalBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                    Start Workshop
                </button>
                <button class="btn btn-danger btn-sm" id="wsStopBtn" style="display:none;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                    Stop Workshop
                </button>
            </div>
        </div>
    </div>

    <!-- Workshops & Sessions -->
    <div class="card">
        <h3 style="margin-bottom:14px; color:var(--accent); font-size:1rem;"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px;"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>Workshops & Sessions</h3>
        <% if (workshops.length === 0) { %>
            <p style="color:var(--text-secondary); text-align:center; padding:20px;">No workshops recorded yet.</p>
        <% } else { %>
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Start Time</th>
                        <th>Duration</th>
                        <th>Participants</th>
                        <th style="text-align:right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% workshops.forEach(function(ws) { %>
                        <%
                            var hasSession = sessions.some(function(s) { return s.workshopId === ws.workshopId; });
                            var matchedSession = sessions.find(function(s) { return s.workshopId === ws.workshopId; });
                        %>
                        <tr data-ctx="workshop" data-wsid="<%= ws.workshopId %>" data-wsstatus="<%= ws.status %>" data-has-session="<%= hasSession %>">
                            <td>
                                <span class="copy-text" data-copy="<%= ws.workshopId %>" title="Click to copy full ID"
                                      style="font-family:monospace; font-size:0.8rem;">
                                    <%= ws.workshopId.substring(0, 12) %>...
                                </span>
                            </td>
                            <td><%= ws.type === 'other' && ws.topicName ? ws.topicName : ws.type %></td>
                            <td>
                                <span style="color: <%= ws.status === 'active' ? 'var(--success)' : ws.status === 'completed' ? 'var(--text-secondary)' : 'var(--warning)' %>">
                                    <%= ws.status %>
                                </span>
                            </td>
                            <td class="local-date" data-ts="<%= new Date(ws.startTime).toISOString() %>"></td>
                            <td><%= matchedSession ? Math.round(matchedSession.totalDuration / 60000) + ' min' : ws.averageDuration + ' min' %></td>
                            <td><%= matchedSession ? matchedSession.totalParticipants : ws.participantCount %></td>
                            <td style="text-align:right;">
                                <div class="actions" style="justify-content:flex-end;">
                                    <% if (hasSession) { %>
                                        <button class="btn-icon btn-icon-sm session-detail-btn" data-wsid="<%= ws.workshopId %>" title="Session Details">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                                        </button>
                                    <% } %>
                                    <button class="btn-icon btn-icon-sm view-data-btn" data-wsid="<%= ws.workshopId %>" data-source="<%= hasSession ? 'session' : 'workshop' %>" title="View Participants">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                    </button>
                                    <a href="/bots/<%= bot._id %>/export/<%= ws.workshopId %>" class="btn-icon btn-icon-sm" title="Export XLSX">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    <% }); %>
                </tbody>
            </table>
        <% } %>
    </div>
</div>

<!-- ─── Leader Detail Popup ──────────────────────────────────────────── -->
<div class="modal-overlay" id="leaderDetailModal">
    <div class="modal-content" style="max-width:380px;">
        <div class="modal-header">
            <h3 id="ldTitle">Leader Details</h3>
            <button class="modal-close" id="ldCloseBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body" style="text-align:center;">
            <div style="position:relative; display:inline-block; margin-bottom:14px;">
                <img id="ldAvatar" src="" alt="" style="width:80px; height:80px; border-radius:50%; border:3px solid var(--accent);" />
                <span id="ldOnlineDot" style="position:absolute;bottom:2px;right:2px;width:16px;height:16px;border-radius:50%;border:3px solid var(--bg-card);background:var(--success);display:none;"></span>
            </div>
            <div id="ldName" style="font-weight:700; font-size:1.1rem; color:var(--text-primary);"></div>
            <div id="ldUsername" style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:14px;"></div>
            <div style="text-align:left;">
                <div class="info-row">
                    <span class="info-label">ID</span>
                    <span class="info-value copy-text" id="ldId" data-copy="" style="font-family:monospace; font-size:0.8rem; cursor:pointer;"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Team</span>
                    <span class="info-value" id="ldTeam"></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Sessions</span>
                    <span class="info-value" id="ldSessions"></span>
                </div>
            </div>
            <div id="ldRoles" style="display:flex; flex-wrap:wrap; gap:4px; margin-top:12px; justify-content:center;"></div>
        </div>
    </div>
</div>

<!-- ─── Workshop Start Modal ─────────────────────────────────────────── -->
<div class="modal-overlay" id="wsModal">
    <div class="modal-content" style="max-width:520px;">
        <div class="modal-header">
            <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px;"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>Start Workshop — <%= bot.teamName %></h3>
            <button class="modal-close" id="wsModalClose"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div id="wsModalAlert" style="display:none; margin-bottom:12px; padding:10px 14px; border-radius:10px; font-size:0.85rem;"></div>
            <div class="ws-modal-grid">
                <div class="form-group">
                    <label>Type</label>
                    <select id="wsType">
                        <option value="workshop">Workshop</option>
                        <option value="formation">Formation</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Duration</label>
                    <select id="wsDuration">
                        <option value="1h30">1h30</option>
                        <option value="2h">2h</option>
                        <option value="45m">45m</option>
                        <option value="1h">1h</option>
                    </select>
                </div>
                <div class="form-group" style="grid-column: 1 / -1;">
                    <label>Start Time</label>
                    <input type="datetime-local" id="wsStartTime" style="font-size:0.85rem;" />
                    <div class="form-hint">Leave empty to start immediately</div>
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:18px;">
                <button class="btn btn-outline btn-sm" id="wsModalCancel">Cancel</button>
                <% if (bot.isSplit) { %>
                    <button class="btn btn-success" id="wsStartBeginner" data-sub="0">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        Start Beginner
                    </button>
                    <button class="btn btn-primary" id="wsStartAdvanced" data-sub="1">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        Start Advanced
                    </button>
                <% } else { %>
                    <button class="btn btn-success" id="wsStartBtn">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        Start Workshop
                    </button>
                <% } %>
            </div>
        </div>
    </div>
</div>

<!-- ─── Session Detail Modal ─────────────────────────────────────────── -->
<div class="modal-overlay" id="sessionDetailModal">
    <div class="modal-content" style="max-width:600px;">
        <div class="modal-header">
            <h3>Session Details</h3>
            <button class="modal-close" id="sdCloseBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div id="sdLoading" style="text-align:center; padding:30px; color:var(--text-secondary);">Loading session details...</div>
            <div id="sdContent" style="display:none;">
                <div class="session-detail-grid">
                    <div class="session-detail-item">
                        <div class="sd-label">Leader</div>
                        <div class="sd-value" id="sdLeader">—</div>
                    </div>
                    <div class="session-detail-item">
                        <div class="sd-label">Type</div>
                        <div class="sd-value" id="sdType">—</div>
                    </div>
                    <div class="session-detail-item">
                        <div class="sd-label">Start Time</div>
                        <div class="sd-value" id="sdStart">—</div>
                    </div>
                    <div class="session-detail-item">
                        <div class="sd-label">End Time</div>
                        <div class="sd-value" id="sdEnd">—</div>
                    </div>
                    <div class="session-detail-item">
                        <div class="sd-label">Total Duration</div>
                        <div class="sd-value" id="sdDuration">—</div>
                    </div>
                    <div class="session-detail-item">
                        <div class="sd-label">Avg. Duration</div>
                        <div class="sd-value" id="sdAvgDuration">—</div>
                    </div>
                    <div class="session-detail-item">
                        <div class="sd-label">Participants</div>
                        <div class="sd-value" id="sdParticipants">—</div>
                    </div>
                    <div class="session-detail-item">
                        <div class="sd-label">Avg. Attendance</div>
                        <div class="sd-value" id="sdAvgAttendance">—</div>
                    </div>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
                    <button class="btn btn-outline btn-sm" id="sdViewParticipants">View Participants</button>
                    <button class="btn btn-danger btn-sm" id="sdStopSession" style="display:none;"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px;margin-right:3px;"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>Stop Session</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ─── Leaderboard Modal ────────────────────────────────────────────── -->
<div class="modal-overlay" id="leaderboardModal">
    <div class="modal-content" style="max-width:700px;">
        <div class="modal-header">
            <h3><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:4px;"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7.4 4 9 7 12 7s4.6-3 7.5-3a2.5 2.5 0 0 1 0 5H18"/><path d="M18 15h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M6 15H4.5a2.5 2.5 0 0 1 0 5H6"/><path d="m2 21 6-6"/><path d="m22 3-6 6"/><path d="M12 12v.01"/><path d="M12 7v5"/></svg>Team Leaderboard — <%= bot.teamName %></h3>
            <button class="modal-close" id="lbCloseBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="lb-tabs">
                <button class="lb-tab active" data-period="all">All Time</button>
                <button class="lb-tab" data-period="month">This Month</button>
                <button class="lb-tab" data-period="week">This Week</button>
            </div>
            <div class="toolbar" style="margin-top:10px;">
                <input type="text" id="lbSearch" placeholder="Search by username or ID..." />
            </div>
            <div id="lbLoading" style="text-align:center; padding:30px; color:var(--text-secondary);">Loading leaderboard...</div>
            <div id="lbContent" style="display:none;">
                <div id="lbSummary" style="font-size:0.85rem; color:var(--text-secondary); margin-bottom:12px;"></div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Member</th>
                            <th>Sessions</th>
                            <th>Voice Time</th>
                            <th>Mic Time</th>
                            <th>Messages</th>
                            <th>Stayed</th>
                        </tr>
                    </thead>
                    <tbody id="lbTbody"></tbody>
                </table>
            </div>
            <div id="lbEmpty" style="display:none; text-align:center; padding:30px; color:var(--text-secondary);">No data for this period.</div>
        </div>
    </div>
</div>

<!-- ─── Team Members Modal ───────────────────────────────────────── -->
<div class="modal-overlay" id="teamMembersModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Team Members — <%= bot.teamName %></h3>
            <button class="modal-close" id="tmCloseBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="toolbar">
                <input type="text" id="tmSearch" placeholder="Search by username or ID..." />
            </div>
            <div id="tmLoading" style="text-align:center; padding:30px; color:var(--text-secondary);">Loading members...</div>
            <div id="tmTable" style="display:none; overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Member</th>
                            <th>Workshops</th>
                            <th>Voice Time</th>
                            <th>Mic Time</th>
                            <th>Messages</th>
                            <th>Stayed</th>
                            <th>Left Early</th>
                        </tr>
                    </thead>
                    <tbody id="tmTbody"></tbody>
                </table>
            </div>
            <div id="tmEmpty" style="display:none; text-align:center; padding:30px; color:var(--text-secondary);">No team members found.</div>
            <div class="pagination" id="tmPagination"></div>
        </div>
    </div>
</div>

<!-- ─── Participants Modal ──────────────────────────────────────────── -->
<div class="modal-overlay" id="participantsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Participants — <span id="modalWsId" style="font-family:monospace; font-size:0.85rem;"></span></h3>
            <button class="modal-close" id="modalCloseBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="toolbar">
                <input type="text" id="pSearch" placeholder="Search by username or ID..." />
                <select id="pFilterStayed">
                    <option value="">All (Stayed)</option>
                    <option value="yes">Stayed</option>
                    <option value="no">Left early</option>
                </select>
                <select id="pFilterMic">
                    <option value="">All (Mic)</option>
                    <option value="used">Used mic</option>
                    <option value="muted">Never unmuted</option>
                </select>
                <select id="pFilterMsg">
                    <option value="">All (Messages)</option>
                    <option value="sent">Sent messages</option>
                    <option value="none">No messages</option>
                </select>
            </div>
            <div id="modalLoading" style="text-align:center; padding:30px; color:var(--text-secondary);">Loading...</div>
            <div id="modalTable" style="display:none; overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Team</th>
                            <th>Voice Time</th>
                            <th>Mic Time</th>
                            <th>Joins</th>
                            <th>Voice Msgs</th>
                            <th>Chat Msgs</th>
                            <th>Stayed</th>
                        </tr>
                    </thead>
                    <tbody id="modalTbody"></tbody>
                </table>
            </div>
            <div id="modalEmpty" style="display:none; text-align:center; padding:30px; color:var(--text-secondary);">No participants found.</div>
            <div class="pagination" id="pPagination"></div>
        </div>
    </div>
</div>

<!-- ─── Video Tutorial Modal ─────────────────────────────────────────── -->
<div class="modal-overlay" id="videoModal">
    <div class="modal-content video-modal-content">
        <div class="modal-header">
            <h3><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-3px;margin-right:6px;"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>Tutorial</h3>
            <button class="modal-close" id="videoCloseBtn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="modal-body">
            <div class="video-wrap">
                <video id="tutorialVideo" controls preload="metadata">
                    <source src="/public/assets/video.mp4" type="video/mp4" />
                    Your browser does not support the video tag.
                </video>
            </div>
        </div>
    </div>
</div>

<!-- Floating tutorial button -->
<button class="fab" id="fabTutorial" title="Watch Tutorial">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"/></svg>
</button>

<script>
(function() {
    var BOT_ID = '<%= bot._id %>';
    var BOT_IS_SPLIT = <%= !!bot.isSplit %>;
    var BOT_TEAM_NAME = '<%= bot.teamName %>';
    var USER_ROLE = '<%= user.role %>';
    var PER_PAGE = 10;
    var allParticipants = [];
    var filteredParticipants = [];
    var currentPage = 1;
    var currentWsId = '';

    // ─── Toast helper (use global) ────────────────────────────────
    function showToast(msg) { window._toast(msg); }

    // (click-to-copy is handled globally by footer.ejs)

    // ─── Leader Detail Popup ──────────────────────────────────────
    (function() {
        var ldModal = document.getElementById('leaderDetailModal');
        document.getElementById('ldCloseBtn').addEventListener('click', function() { ldModal.classList.remove('active'); });
        ldModal.addEventListener('click', function(e) { if (e.target === ldModal) ldModal.classList.remove('active'); });

        document.querySelectorAll('.leader-avatar').forEach(function(el) {
            el.addEventListener('click', function(e) {
                // Ignore if right-click
                if (e.button && e.button === 2) return;
                var d = el.dataset;
                document.getElementById('ldAvatar').src = d.leaderAvatar;
                document.getElementById('ldName').textContent = d.leaderName;
                document.getElementById('ldUsername').textContent = '@' + d.leaderUsername;
                document.getElementById('ldId').textContent = d.leaderId;
                document.getElementById('ldId').dataset.copy = d.leaderId;
                document.getElementById('ldTeam').textContent = d.leaderTeam;
                document.getElementById('ldSessions').textContent = d.leaderSessions;
                var dot = document.getElementById('ldOnlineDot');
                dot.style.display = d.leaderOnline === 'true' ? 'block' : 'none';

                // Roles
                var rolesDiv = document.getElementById('ldRoles');
                rolesDiv.innerHTML = '';
                if (d.leaderRoles) {
                    var roles = d.leaderRoles.split('|||').filter(Boolean);
                    roles.slice(0, 12).forEach(function(r) {
                        var tag = document.createElement('span');
                        tag.className = 'tt-role-tag';
                        tag.textContent = r;
                        rolesDiv.appendChild(tag);
                    });
                    if (roles.length > 12) {
                        var more = document.createElement('span');
                        more.className = 'tt-role-tag';
                        more.textContent = '+' + (roles.length - 12);
                        rolesDiv.appendChild(more);
                    }
                }
                ldModal.classList.add('active');
            });
        });
    })();

    // ─── Format helpers ───────────────────────────────────────────
    function formatMs(ms) {
        if (ms <= 0) return '0s';
        var s = Math.floor(ms / 1000) % 60;
        var m = Math.floor(ms / 60000) % 60;
        var h = Math.floor(ms / 3600000);
        if (h > 0) return h + 'h ' + m + 'm';
        if (m > 0) return m + 'm ' + s + 's';
        return s + 's';
    }
    function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function fmtDate(d) { var dt = new Date(d); return dt.toLocaleDateString() + ' ' + dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); }

    // Format server-rendered dates client-side (correct timezone)
    document.querySelectorAll('.local-date').forEach(function(el) {
        var d = new Date(el.dataset.ts);
        el.textContent = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    });

    // ─── Generic modal helper ─────────────────────────────────────
    function setupModal(overlayId, closeBtnId) {
        var overlay = document.getElementById(overlayId);
        var closeBtn = document.getElementById(closeBtnId);
        if (closeBtn) closeBtn.addEventListener('click', function() { overlay.classList.remove('active'); });
        overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.classList.remove('active'); });
        return overlay;
    }

    // ─── Participants Modal ───────────────────────────────────────
    var modal = setupModal('participantsModal', 'modalCloseBtn');

    document.querySelectorAll('.view-data-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var wsid = btn.dataset.wsid;
            var source = btn.dataset.source || 'workshop';
            currentWsId = wsid;
            currentPage = 1;
            document.getElementById('modalWsId').textContent = wsid.substring(0, 20) + '...';
            modal.classList.add('active');
            document.getElementById('modalLoading').style.display = '';
            document.getElementById('modalTable').style.display = 'none';
            document.getElementById('modalEmpty').style.display = 'none';
            document.getElementById('pPagination').innerHTML = '';
            document.getElementById('pSearch').value = '';
            document.getElementById('pFilterStayed').value = '';
            document.getElementById('pFilterMic').value = '';
            document.getElementById('pFilterMsg').value = '';

            var apiUrl = source === 'session'
                ? '/api/sessions/' + encodeURIComponent(wsid) + '/participants'
                : '/api/workshops/' + encodeURIComponent(wsid) + '/participants';

            fetch(apiUrl).then(function(r) { return r.json(); }).then(function(data) {
                allParticipants = data;
                document.getElementById('modalLoading').style.display = 'none';
                applyFilters();
            }).catch(function() {
                document.getElementById('modalLoading').textContent = 'Failed to load participants.';
            });
        });
    });

    document.getElementById('pSearch').addEventListener('input', function() { currentPage = 1; applyFilters(); });
    document.getElementById('pFilterStayed').addEventListener('change', function() { currentPage = 1; applyFilters(); });
    document.getElementById('pFilterMic').addEventListener('change', function() { currentPage = 1; applyFilters(); });
    document.getElementById('pFilterMsg').addEventListener('change', function() { currentPage = 1; applyFilters(); });

    function applyFilters() {
        var q = document.getElementById('pSearch').value.toLowerCase().trim();
        var stayed = document.getElementById('pFilterStayed').value;
        var mic = document.getElementById('pFilterMic').value;
        var msg = document.getElementById('pFilterMsg').value;
        filteredParticipants = allParticipants.filter(function(p) {
            if (q && p.username.toLowerCase().indexOf(q) === -1 && p.discordId.indexOf(q) === -1) return false;
            if (stayed === 'yes' && !p.stayedUntilEnd) return false;
            if (stayed === 'no' && p.stayedUntilEnd) return false;
            if (mic === 'used' && p.totalMicMs <= 0) return false;
            if (mic === 'muted' && p.totalMicMs > 0) return false;
            if (msg === 'sent' && (p.voiceChatMessages + p.memberChatMessages) <= 0) return false;
            if (msg === 'none' && (p.voiceChatMessages + p.memberChatMessages) > 0) return false;
            return true;
        });
        renderPage();
    }

    function renderPage() {
        var tbody = document.getElementById('modalTbody');
        var tableEl = document.getElementById('modalTable');
        var emptyEl = document.getElementById('modalEmpty');
        var pagEl = document.getElementById('pPagination');
        if (filteredParticipants.length === 0) { tableEl.style.display = 'none'; emptyEl.style.display = ''; pagEl.innerHTML = ''; return; }
        tableEl.style.display = ''; emptyEl.style.display = 'none';
        var totalPages = Math.ceil(filteredParticipants.length / PER_PAGE);
        if (currentPage > totalPages) currentPage = totalPages;
        var start = (currentPage - 1) * PER_PAGE;
        var pageData = filteredParticipants.slice(start, start + PER_PAGE);
        tbody.innerHTML = '';
        pageData.forEach(function(p) {
            var tr = document.createElement('tr');
            tr.dataset.ctx = 'user-row';
            tr.dataset.discordId = p.discordId;
            tr.dataset.username = p.username;
            tr.innerHTML =
                '<td><span class="copy-text" data-copy="' + esc(p.discordId) + '" title="Click to copy Discord ID: ' + esc(p.discordId) + '" style="font-weight:600;cursor:pointer;">' + esc(p.username) + '</span></td>' +
                '<td>' + esc(p.teamLabel) + '</td><td>' + formatMs(p.totalVoiceMs) + '</td><td>' + formatMs(p.totalMicMs) + '</td>' +
                '<td>' + p.joinCount + '</td><td>' + p.voiceChatMessages + '</td><td>' + p.memberChatMessages + '</td>' +
                '<td style="color:' + (p.stayedUntilEnd ? 'var(--success)' : 'var(--danger)') + '">' + (p.stayedUntilEnd ? 'Yes' : 'No') + '</td>';
            tbody.appendChild(tr);
        });
        buildPagination(pagEl, currentPage, totalPages, function(p) { currentPage = p; renderPage(); });
    }

    // ─── Reusable pagination builder ──────────────────────────────
    function buildPagination(container, current, total, callback) {
        container.innerHTML = '';
        if (total <= 1) return;
        function addBtn(label, page, disabled, active) {
            var b = document.createElement('button');
            b.textContent = label; b.disabled = disabled;
            if (active) b.className = 'active';
            if (!disabled && !active) b.addEventListener('click', function() { callback(page); });
            container.appendChild(b);
        }
        addBtn('←', current - 1, current === 1, false);
        var pages = [];
        if (total <= 7) { for (var i = 1; i <= total; i++) pages.push(i); }
        else {
            pages.push(1);
            if (current > 3) pages.push('...');
            for (var i = Math.max(2, current - 1); i <= Math.min(total - 1, current + 1); i++) pages.push(i);
            if (current < total - 2) pages.push('...');
            pages.push(total);
        }
        pages.forEach(function(p) {
            if (p === '...') { var sp = document.createElement('button'); sp.textContent = '...'; sp.disabled = true; container.appendChild(sp); }
            else addBtn(String(p), p, false, p === current);
        });
        addBtn('→', current + 1, current === total, false);
    }

    // ─── Split-aware action helper ──────────────────────────────
    function splitAwareAction(action, actionLabel) {
        if (!BOT_IS_SPLIT) {
            fetch('/api/bots/' + BOT_ID + '/' + action, { method: 'POST' })
                .then(function(r) { return r.json(); })
                .then(function(d) { showToast(d.message); });
            return;
        }
        window._snackbar.show(
            'Select which bot to ' + actionLabel + ':',
            [
                { label: 'Beginner Bot', value: 'beginner' },
                { label: 'Advanced Bot', value: 'advanced' },
                { label: 'Both Bots', value: 'all' }
            ],
            function(val) {
                fetch('/api/bots/' + BOT_ID + '/' + action + '?subBot=' + val, { method: 'POST' })
                    .then(function(r) { return r.json(); })
                    .then(function(d) { showToast(d.message); });
            }
        );
    }

    // ─── Disconnect / Reconnect (split-aware) ────────────────────
    var disBtn = document.getElementById('disconnectBtn');
    var reBtn = document.getElementById('reconnectBtn');
    if (disBtn) {
        disBtn.addEventListener('click', function() {
            disBtn.disabled = true;
            splitAwareAction('disconnect', 'disconnect');
            setTimeout(function() { disBtn.disabled = false; }, 2000);
        });
    }
    if (reBtn) {
        reBtn.addEventListener('click', function() {
            reBtn.disabled = true;
            splitAwareAction('reconnect', 'reconnect');
            setTimeout(function() { reBtn.disabled = false; }, 2000);
        });
    }

    // ─── Workshop Modal (start) ───────────────────────────────────
    var wsModal = setupModal('wsModal', 'wsModalClose');
    var wsStatusEl = document.getElementById('wsControlStatus');
    var wsOpenBtn = document.getElementById('wsOpenModalBtn');
    var wsStopBtn = document.getElementById('wsStopBtn');
    var BOT_IS_SPLIT = <%= bot.isSplit ? 'true' : 'false' %>;
    document.getElementById('wsModalCancel').addEventListener('click', function() { wsModal.classList.remove('active'); });

    <% var activeWs = workshops.find(function(w) { return w.status === 'active'; }); %>
    <% var scheduledWs = workshops.find(function(w) { return w.status === 'scheduled'; }); %>
    <% if (activeWs) { %>
        wsStatusEl.innerHTML = '<span class="dot-icon dot-green"></span> Active workshop: <strong><%= activeWs.workshopId.substring(0, 16) %>...</strong>';
        wsOpenBtn.style.display = 'none';
        wsStopBtn.style.display = '';
        wsStopBtn.dataset.wsid = '<%= activeWs.workshopId %>';
    <% } else if (scheduledWs) { %>
        wsOpenBtn.style.display = 'none';
        wsStopBtn.style.display = '';
        wsStopBtn.dataset.wsid = '<%= scheduledWs.workshopId %>';
        // Show scheduled badge with countdown
        (function() {
            var startTime = new Date('<%= new Date(scheduledWs.startTime).toISOString() %>').getTime();
            function updateCountdown() {
                var now = Date.now();
                var diff = startTime - now;
                if (diff <= 0) {
                    wsStatusEl.innerHTML = '<span class="dot-icon dot-green"></span> Workshop starting now...';
                    clearInterval(countdownTimer);
                    setTimeout(function() { location.reload(); }, 5000);
                    return;
                }
                var h = Math.floor(diff / 3600000);
                var m = Math.floor((diff % 3600000) / 60000);
                var s = Math.floor((diff % 60000) / 1000);
                var timeStr = h > 0 ? h + 'h ' + m + 'm ' + s + 's' : m + 'm ' + s + 's';
                wsStatusEl.innerHTML = '<span class="ws-scheduled-badge"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px;"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Scheduled — starts in <span class="countdown">' + timeStr + '</span></span>';
            }
            updateCountdown();
            var countdownTimer = setInterval(updateCountdown, 1000);
        })();
    <% } else { %>
        wsStatusEl.textContent = 'No active workshop.';
    <% } %>

    wsOpenBtn.addEventListener('click', function() {
        var alertEl = document.getElementById('wsModalAlert');
        alertEl.style.display = 'none';
        wsModal.classList.add('active');
    });

    // ─── Workshop start handler (supports split & single mode) ──
    function doStartWorkshop(subBot) {
        var type = document.getElementById('wsType').value;
        var duration = document.getElementById('wsDuration').value;
        var startTimeInput = document.getElementById('wsStartTime').value;
        var body = { type: type, duration: duration };
        if (startTimeInput) body.startTime = startTimeInput;
        if (subBot !== undefined) body.subBot = subBot;

        // Disable all start buttons
        var btns = document.querySelectorAll('#wsStartBtn, #wsStartBeginner, #wsStartAdvanced');
        btns.forEach(function(b) { b.disabled = true; b.style.opacity = '0.6'; });

        fetch('/api/bots/' + BOT_ID + '/workshop/start', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        }).then(function(r) { return r.json(); }).then(function(d) {
            if (d.success) {
                wsModal.classList.remove('active');
                wsStatusEl.innerHTML = '<span class="dot-icon dot-green"></span> Workshop started!';
                wsOpenBtn.style.display = 'none';
                wsStopBtn.style.display = '';
                wsStopBtn.dataset.wsid = d.workshopId;
                setTimeout(function() { location.reload(); }, 1500);
            } else {
                var alertEl = document.getElementById('wsModalAlert');
                alertEl.textContent = d.message || 'Failed to start workshop';
                alertEl.style.display = '';
                alertEl.style.background = 'rgba(255,107,107,0.1)';
                alertEl.style.color = 'var(--danger)';
                alertEl.style.border = '1px solid var(--danger)';
                btns.forEach(function(b) { b.disabled = false; b.style.opacity = ''; });
            }
        }).catch(function() {
            btns.forEach(function(b) { b.disabled = false; b.style.opacity = ''; });
        });
    }

    if (BOT_IS_SPLIT) {
        document.getElementById('wsStartBeginner').addEventListener('click', function() { doStartWorkshop(0); });
        document.getElementById('wsStartAdvanced').addEventListener('click', function() { doStartWorkshop(1); });
    } else {
        document.getElementById('wsStartBtn').addEventListener('click', function() { doStartWorkshop(); });
    }

    wsStopBtn.addEventListener('click', function() {
        window.showConfirm({
            title: 'Stop Workshop',
            message: 'Stop the currently active workshop? Participants will be logged.',
            confirmText: 'Stop',
            cancelText: 'Cancel',
            type: 'danger',
            onConfirm: function() {
                wsStopBtn.disabled = true; wsStopBtn.textContent = 'Stopping...';
                fetch('/api/bots/' + BOT_ID + '/workshop/stop', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ workshopId: wsStopBtn.dataset.wsid })
                }).then(function(r) { return r.json(); }).then(function(d) {
                    if (d.success) {
                        wsStatusEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="vertical-align:-2px;margin-right:3px;"><rect x="4" y="4" width="16" height="16" rx="2"/></svg> Workshop stopped.';
                        wsStopBtn.style.display = 'none'; wsOpenBtn.style.display = '';
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        wsStatusEl.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px;margin-right:3px;color:var(--warning);"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg> ' + (d.message || 'Failed');
                        wsStopBtn.disabled = false; wsStopBtn.textContent = 'Stop Workshop';
                    }
                }).catch(function() { wsStopBtn.disabled = false; wsStopBtn.textContent = 'Stop Workshop'; });
            }
        });
    });

    // ─── Session Detail Modal ─────────────────────────────────────
    var sdModal = setupModal('sessionDetailModal', 'sdCloseBtn');
    var sdCurrentWsId = '';

    document.querySelectorAll('.session-detail-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            sdCurrentWsId = btn.dataset.wsid;
            sdModal.classList.add('active');
            document.getElementById('sdLoading').style.display = '';
            document.getElementById('sdContent').style.display = 'none';

            fetch('/api/sessions/' + encodeURIComponent(sdCurrentWsId) + '/detail')
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    document.getElementById('sdLoading').style.display = 'none';
                    document.getElementById('sdContent').style.display = '';
                    document.getElementById('sdLeader').textContent = d.leaderName || d.leaderID;
                    document.getElementById('sdType').textContent = d.type;
                    document.getElementById('sdStart').textContent = d.startTime ? fmtDate(d.startTime) : '—';
                    document.getElementById('sdEnd').textContent = d.endTime ? fmtDate(d.endTime) : 'Ongoing';
                    document.getElementById('sdDuration').textContent = d.totalDuration ? Math.round(d.totalDuration / 60000) + ' min' : '—';
                    document.getElementById('sdAvgDuration').textContent = d.averageDuration ? d.averageDuration + ' min' : '—';
                    document.getElementById('sdParticipants').textContent = d.totalParticipants || 0;
                    document.getElementById('sdAvgAttendance').textContent = d.averageAttendanceTime ? Math.round(d.averageAttendanceTime / 60000) + ' min' : '—';

                    // Show stop button if workshop is still active
                    var stopBtn = document.getElementById('sdStopSession');
                    if (d.workshopStatus === 'active') {
                        stopBtn.style.display = '';
                        stopBtn.dataset.wsid = d.workshopId;
                    } else {
                        stopBtn.style.display = 'none';
                    }
                }).catch(function() {
                    document.getElementById('sdLoading').textContent = 'Failed to load session details.';
                });
        });
    });

    document.getElementById('sdViewParticipants').addEventListener('click', function() {
        sdModal.classList.remove('active');
        // Trigger view-data for this session
        var btn = document.querySelector('.view-data-btn[data-wsid="' + sdCurrentWsId + '"][data-source="session"]');
        if (btn) btn.click();
    });

    document.getElementById('sdStopSession').addEventListener('click', function() {
        var stopBtn = document.getElementById('sdStopSession');
        window.showConfirm({
            title: 'Stop Session',
            message: 'Stop this active session? Data will be saved.',
            confirmText: 'Stop',
            cancelText: 'Cancel',
            type: 'danger',
            onConfirm: function() {
                stopBtn.disabled = true; stopBtn.textContent = 'Stopping...';
                fetch('/api/sessions/' + encodeURIComponent(stopBtn.dataset.wsid) + '/stop', { method: 'POST' })
                    .then(function(r) { return r.json(); })
                    .then(function(d) {
                        if (d.success) {
                            showToast('Session stopped');
                            sdModal.classList.remove('active');
                            setTimeout(function() { location.reload(); }, 1500);
                        } else {
                            stopBtn.textContent = d.message || 'Failed';
                            stopBtn.disabled = false;
                        }
                    }).catch(function() { stopBtn.textContent = 'Failed'; stopBtn.disabled = false; });
            }
        });
    });

    // ─── Leaderboard Modal ────────────────────────────────────────
    var lbModal = setupModal('leaderboardModal', 'lbCloseBtn');
    var lbPeriod = 'all';
    var lbAllData = [];
    var lbTotalSessions = 0;

    document.getElementById('leaderboardBtn').addEventListener('click', function() {
        lbModal.classList.add('active');
        document.getElementById('lbSearch').value = '';
        loadLeaderboard('all');
    });

    document.querySelectorAll('.lb-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.lb-tab').forEach(function(t) { t.classList.remove('active'); });
            tab.classList.add('active');
            document.getElementById('lbSearch').value = '';
            loadLeaderboard(tab.dataset.period);
        });
    });

    document.getElementById('lbSearch').addEventListener('input', function() { lbRender(); });

    function loadLeaderboard(period) {
        lbPeriod = period;
        document.getElementById('lbLoading').style.display = '';
        document.getElementById('lbContent').style.display = 'none';
        document.getElementById('lbEmpty').style.display = 'none';

        fetch('/api/bots/' + BOT_ID + '/leaderboard?period=' + period)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                document.getElementById('lbLoading').style.display = 'none';
                lbAllData = data.leaderboard || [];
                lbTotalSessions = data.totalSessions || 0;
                lbRender();
            }).catch(function() {
                document.getElementById('lbLoading').textContent = 'Failed to load leaderboard.';
            });
    }

    function lbRender() {
        var q = document.getElementById('lbSearch').value.toLowerCase().trim();
        var filtered = lbAllData;
        if (q) {
            filtered = lbAllData.filter(function(m) {
                return m.username.toLowerCase().indexOf(q) !== -1 ||
                    (m.globalName || '').toLowerCase().indexOf(q) !== -1 ||
                    m.discordId.indexOf(q) !== -1;
            });
        }
        if (filtered.length === 0) {
            document.getElementById('lbContent').style.display = 'none';
            document.getElementById('lbEmpty').style.display = '';
            document.getElementById('lbEmpty').textContent = q ? 'No results for "' + q + '"' : 'No data for this period.';
            return;
        }
        document.getElementById('lbContent').style.display = '';
        document.getElementById('lbEmpty').style.display = 'none';
        document.getElementById('lbSummary').textContent = 'Total sessions: ' + lbTotalSessions + ' — ' + (q ? filtered.length + '/' : '') + lbAllData.length + ' participants';
        var tbody = document.getElementById('lbTbody');
        tbody.innerHTML = '';
        filtered.forEach(function(m, i) {
            var origIdx = lbAllData.indexOf(m);
            var rankClass = origIdx === 0 ? 'gold' : origIdx === 1 ? 'silver' : origIdx === 2 ? 'bronze' : '';
            var tr = document.createElement('tr');
            tr.dataset.ctx = 'user-row';
            tr.dataset.discordId = m.discordId;
            tr.dataset.username = m.globalName || m.username;
            tr.innerHTML =
                '<td><span class="lb-rank ' + rankClass + '">' + (origIdx + 1) + '</span></td>' +
                '<td><div style="display:flex;align-items:center;gap:8px;">' +
                    (m.avatarUrl ? '<img src="' + esc(m.avatarUrl) + '" style="width:28px;height:28px;border-radius:50%;" />' : '') +
                    '<div><div style="font-weight:600;font-size:0.88rem;">' + esc(m.globalName || m.username) + '</div>' +
                    '<div style="font-size:0.75rem;color:var(--text-secondary);">@' + esc(m.username) + '</div></div></div></td>' +
                '<td style="font-weight:600;">' + m.sessions + '</td>' +
                '<td>' + formatMs(m.totalVoiceMs) + '</td>' +
                '<td>' + formatMs(m.totalMicMs) + '</td>' +
                '<td>' + m.totalMsgs + '</td>' +
                '<td style="color:var(--success);">' + m.stayedCount + '</td>';
            tbody.appendChild(tr);
        });
    }

    // ─── Token access request buttons (BE role) ───────────────────
    document.querySelectorAll('.token-request-btn').forEach(function(btn) {
        btn.addEventListener('click', async function() {
            btn.disabled = true; btn.textContent = 'Sending...';
            try {
                var res = await fetch('/api/token-request', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ botId: btn.dataset.bot, label: btn.dataset.label })
                });
                if (res.ok) { btn.textContent = 'Request Sent'; btn.style.color = 'var(--success)'; btn.style.borderColor = 'var(--success)'; }
                else { btn.textContent = 'Failed'; btn.style.color = 'var(--danger)'; setTimeout(function() { btn.textContent = 'Request Access'; btn.disabled = false; btn.style.color = ''; btn.style.borderColor = ''; }, 3000); }
            } catch (e) { btn.textContent = 'Error'; setTimeout(function() { btn.textContent = 'Request Access'; btn.disabled = false; }, 3000); }
        });
    });

    // ─── Team Members Modal ───────────────────────────────────────
    var tmModal = setupModal('teamMembersModal', 'tmCloseBtn');
    var tmAllMembers = [], tmFiltered = [], tmPage = 1, TM_PER_PAGE = 12;

    document.getElementById('teamMembersBtn').addEventListener('click', function() {
        tmModal.classList.add('active');
        document.getElementById('tmLoading').style.display = '';
        document.getElementById('tmTable').style.display = 'none';
        document.getElementById('tmEmpty').style.display = 'none';
        document.getElementById('tmPagination').innerHTML = '';
        document.getElementById('tmSearch').value = '';
        tmPage = 1;

        fetch('/api/bots/' + BOT_ID + '/members').then(function(r) { return r.json(); }).then(function(data) {
            tmAllMembers = data;
            document.getElementById('tmLoading').style.display = 'none';
            tmApplyFilter();
        }).catch(function() { document.getElementById('tmLoading').textContent = 'Failed to load members.'; });
    });

    document.getElementById('tmSearch').addEventListener('input', function() { tmPage = 1; tmApplyFilter(); });

    function tmApplyFilter() {
        var q = document.getElementById('tmSearch').value.toLowerCase().trim();
        tmFiltered = tmAllMembers.filter(function(m) {
            if (q && m.username.toLowerCase().indexOf(q) === -1 && (m.globalName || '').toLowerCase().indexOf(q) === -1 && m.discordId.indexOf(q) === -1) return false;
            return true;
        });
        tmRenderPage();
    }

    function tmRenderPage() {
        var tbody = document.getElementById('tmTbody');
        var tableEl = document.getElementById('tmTable');
        var emptyEl = document.getElementById('tmEmpty');
        var pagEl = document.getElementById('tmPagination');
        if (tmFiltered.length === 0) { tableEl.style.display = 'none'; emptyEl.style.display = ''; pagEl.innerHTML = ''; return; }
        tableEl.style.display = ''; emptyEl.style.display = 'none';
        var totalPages = Math.ceil(tmFiltered.length / TM_PER_PAGE);
        if (tmPage > totalPages) tmPage = totalPages;
        var start = (tmPage - 1) * TM_PER_PAGE;
        var pageData = tmFiltered.slice(start, start + TM_PER_PAGE);
        tbody.innerHTML = '';
        pageData.forEach(function(m) {
            var tr = document.createElement('tr');
            tr.dataset.ctx = 'user-row';
            tr.dataset.discordId = m.discordId;
            tr.dataset.username = m.globalName || m.username;
            tr.innerHTML =
                '<td><div style="display:flex;align-items:center;gap:8px;">' +
                    '<img src="' + esc(m.avatarUrl) + '" style="width:28px;height:28px;border-radius:50%;" />' +
                    '<div><div style="font-weight:600;font-size:0.88rem;">' + esc(m.globalName || m.username) + '</div>' +
                    '<div style="font-size:0.75rem;color:var(--text-secondary);">@' + esc(m.username) + '</div></div></div></td>' +
                '<td>' + m.workshopsJoined + '</td><td>' + formatMs(m.totalVoiceMs) + '</td><td>' + formatMs(m.totalMicMs) + '</td>' +
                '<td>' + m.totalMsgs + '</td><td style="color:var(--success);">' + m.stayedCount + '</td>' +
                '<td style="color:var(--danger);">' + m.leftEarlyCount + '</td>';
            tbody.appendChild(tr);
        });
        buildPagination(pagEl, tmPage, totalPages, function(p) { tmPage = p; tmRenderPage(); });
    }

    // ─── Video Tutorial FAB ───────────────────────────────────────
    var videoModal = setupModal('videoModal', 'videoCloseBtn');
    document.getElementById('fabTutorial').addEventListener('click', function() {
        videoModal.classList.add('active');
    });
    document.getElementById('videoCloseBtn').addEventListener('click', function() {
        document.getElementById('tutorialVideo').pause();
    });

    // ─── Context menus for table rows and avatars ─────────────────
    document.addEventListener('contextmenu', function(e) {
        // ─── User row context menu (leaderboard, members, participants) ──
        var userRow = e.target.closest('tr[data-ctx="user-row"]');
        if (userRow) {
            e.preventDefault();
            e.stopPropagation();
            var uid = userRow.dataset.discordId;
            var uname = userRow.dataset.username;
            var I = window._ctxIcons;
            window._ctxMenu.open(e, [
                { icon: I.copy, label: 'Copy User ID', action: function() {
                    navigator.clipboard.writeText(uid).then(function() { showToast('Copied: ' + uid); });
                }},
                { icon: I.user, label: 'Copy Username', action: function() {
                    navigator.clipboard.writeText(uname).then(function() { showToast('Copied: ' + uname); });
                }}
            ], {});
            return;
        }

        // Workshop row context menu
        var wsRow = e.target.closest('tr[data-ctx="workshop"]');
        if (wsRow) {
            var wsid = wsRow.dataset.wsid;
            var status = wsRow.dataset.wsstatus;
            var hasSession = wsRow.dataset.hasSession === 'true';
            var I = window._ctxIcons;
            var items = [];
            if (hasSession) {
                items.push({ icon: I.info, label: 'Session Details', action: function() {
                    var btn = wsRow.querySelector('.session-detail-btn');
                    if (btn) btn.click();
                }});
            }
            items.push({ icon: I.view, label: 'View Participants', action: function() {
                var btn = wsRow.querySelector('.view-data-btn');
                if (btn) btn.click();
            }});
            items.push({ icon: I.download, label: 'Export XLSX', action: function() {
                window.location.href = '/bots/' + BOT_ID + '/export/' + wsid;
            }});
            var copyChildren = [
                { icon: I.copy, label: 'Copy ID', action: function() {
                    navigator.clipboard.writeText(wsid).then(function() { showToast('Copied: ' + wsid); });
                }}
            ];
            items.push(copyChildren[0]);
            if (status === 'active' || status === 'scheduled') {
                items.push({ divider: true });
                items.push({ icon: I.stop, label: 'Stop Workshop', danger: true, action: function() {
                    window.showConfirm({
                        title: 'Stop Workshop',
                        message: 'Stop this workshop? Participants will be logged.',
                        confirmText: 'Stop',
                        cancelText: 'Cancel',
                        type: 'danger',
                        onConfirm: function() {
                            fetch('/api/bots/' + BOT_ID + '/workshop/stop', {
                                method: 'POST', headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ workshopId: wsid })
                            }).then(function(r) { return r.json(); }).then(function(d) {
                                showToast(d.message || 'Done');
                                if (d.success) setTimeout(function() { location.reload(); }, 1500);
                            });
                        }
                    });
                }});
            }
            window._ctxMenu.open(e, items, { wsid: wsid });
            return;
        }

        // Leader avatar context menu (right-click)
        var avatar = e.target.closest('.avatar-item.leader-avatar');
        if (avatar) {
            e.preventDefault();
            e.stopPropagation();
            var userId = avatar.dataset.leaderId;
            var name = avatar.dataset.leaderName;
            var username = avatar.dataset.leaderUsername;
            var I = window._ctxIcons;

            window._ctxMenu.open(e, [
                { icon: I.copy, label: 'Copy User ID', action: function() {
                    navigator.clipboard.writeText(userId).then(function() { showToast('Copied: ' + userId); });
                }},
                { icon: I.user, label: 'Copy Username', action: function() {
                    navigator.clipboard.writeText(username).then(function() { showToast('Copied: @' + username); });
                }},
                { icon: I.copy, label: 'Copy Display Name', action: function() {
                    navigator.clipboard.writeText(name).then(function() { showToast('Copied: ' + name); });
                }}
            ], { userId: userId });
            return;
        }
    });
})();
</script>

<!-- Socket.IO for live updates -->
<script src="/socket.io/socket.io.js"></script>
<script>
(function() {
    var TEAM_NAME = '<%= bot.teamName %>';
    var socket = io();

    socket.on('connect', function() {
        socket.emit('join:bot', TEAM_NAME);
    });

    var statusDot = document.querySelector('.status-dot');

    socket.on('bot:status', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        if (statusDot) {
            statusDot.classList.remove('status-active', 'status-inactive', 'status-warning');
            switch (data.status) {
                case 'connected': case 'activated': statusDot.classList.add('status-active'); break;
                case 'reconnecting': statusDot.classList.add('status-warning'); break;
                default: statusDot.classList.add('status-inactive');
            }
        }
        var msgs = { connected: 'Bot connected', disconnected: 'Bot disconnected', reconnecting: 'Reconnecting...', error: 'Bot error', deactivated: 'Deactivated', activated: 'Activated' };
        window._toast(msgs[data.status] || data.detail || data.status);
    });

    socket.on('bot:data', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        switch (data.event) {
            case 'workshop:started':
            case 'workshop:stopped':
                setTimeout(function() { location.reload(); }, 2000);
                break;
            case 'config:updated':
                window._toast('Config updated — refreshing...');
                setTimeout(function() { location.reload(); }, 2000);
                break;
            case 'profile:updated':
                window._toast('Profile updated');
                break;
        }
    });

    // ─── New socket events ────────────────────────────────────────
    socket.on('session:started', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        window._toast('Session started');
    });

    socket.on('session:stopped', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        window._toast('Session stopped — ' + (data.totalParticipants || 0) + ' participants');
        setTimeout(function() { location.reload(); }, 3000);
    });

    socket.on('participant:joined', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        window._toast(data.username + ' joined');
    });

    socket.on('participant:left', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        window._toast(data.username + ' left');
    });

    socket.on('workshop:reminder', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        window._toast('Workshop reminder: ' + data.minutesUntilStart + 'min until ' + data.type);
    });

    socket.on('leader:role-changed', function(data) {
        if (data.teamName !== TEAM_NAME) return;
        setTimeout(function() { location.reload(); }, 2000);
    });

    // ─── Leader online green dots (real-time) ─────────────────────
    socket.on('global:user-online', function(data) {
        var dot = document.querySelector('[data-leader-id="' + data.discordId + '"] .leader-online-dot');
        if (dot) dot.style.display = 'block';
    });
    socket.on('global:user-offline', function(data) {
        var dot = document.querySelector('[data-leader-id="' + data.discordId + '"] .leader-online-dot');
        if (dot) dot.style.display = 'none';
    });
})();
</script>

<%- include('footer') %>
